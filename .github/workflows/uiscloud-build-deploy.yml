name: UISCloud - Build & Deploy

# Triggers:
#   - main ë¸Œëžœì¹˜ push: ì´ë¯¸ì§€ ë¹Œë“œ + ìžë™ ë°°í¬ (DEPLOY_ENABLED=true ì‹œ)
#   - v*.*.* íƒœê·¸ push: ì´ë¯¸ì§€ ë¹Œë“œ + ìžë™ ë°°í¬
#   - ìˆ˜ë™ ì‹¤í–‰: ë¹Œë“œë§Œ or ë¹Œë“œ+ë°°í¬ ì„ íƒ ê°€ëŠ¥
on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  workflow_dispatch:
    inputs:
      deploy:
        description: "ë¹Œë“œ í›„ ì„œë²„ì— ë°”ë¡œ ë°°í¬"
        type: boolean
        required: false
        default: false

env:
  REGISTRY: ghcr.io
  # ghcr.io/{owner}/{repo}/web-server í˜•íƒœë¡œ ì´ë¯¸ì§€ ì €ìž¥
  WEB_IMAGE: ghcr.io/${{ github.repository }}/web-server

jobs:
  # â”€â”€â”€ Job 1: ì›¹ ì„œë²„ Docker ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-web:
    name: ì›¹ ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # ghcr.io ì´ë¯¸ì§€ í‘¸ì‹œ ê¶Œí•œ

    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-tags: ${{ steps.meta.outputs.tags }}

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì • (ë©€í‹°í”Œëž«í¼ ë¹Œë“œ ì§€ì›)
        uses: docker/setup-buildx-action@v3

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ì´ë¯¸ì§€ íƒœê·¸ & ë ˆì´ë¸” ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.WEB_IMAGE }}
          tags: |
            # main ë¸Œëžœì¹˜ â†’ :latest
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # ë¸Œëžœì¹˜ëª… íƒœê·¸ (ì˜ˆ: main â†’ :main)
            type=ref,event=branch
            # ë²„ì „ íƒœê·¸ (ì˜ˆ: v1.2.3 â†’ :1.2.3, :1.2)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # ì»¤ë°‹ SHA íƒœê·¸ (ì˜ˆ: :sha-abc1234)
            type=sha,prefix=sha-,format=short

      - name: ì›¹ ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ & ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v6
        with:
          context: web/
          file: web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # GitHub Actions ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹Œë“œ ì†ë„ ê°œì„ 
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_OPTIONS=--max-old-space-size=4096

      - name: ë¹Œë“œ ê²°ê³¼ ìš”ì•½ ì¶œë ¥
        run: |
          echo "## ë¹Œë“œ ì™„ë£Œ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ | \`${{ env.WEB_IMAGE }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| íƒœê·¸ | \`${{ steps.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€ Job 2: ì„œë²„ ë°°í¬ (ì¡°ê±´ë¶€ ì‹¤í–‰) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ì‹¤í–‰ ì¡°ê±´: (main/íƒœê·¸ push OR ìˆ˜ë™ ë°°í¬ ìš”ì²­) AND DEPLOY_ENABLED=true
  deploy:
    name: í”„ë¡œë•ì…˜ ì„œë²„ ë°°í¬
    needs: build-web
    runs-on: ubuntu-latest
    if: |
      (
        github.ref == 'refs/heads/main' ||
        startsWith(github.ref, 'refs/tags/')
      ) &&
      (
        github.event_name == 'push' ||
        github.event.inputs.deploy == 'true'
      ) &&
      vars.DEPLOY_ENABLED == 'true'

    # GitHub Environmentsë¡œ ë°°í¬ ìŠ¹ì¸ ë° ì‹œí¬ë¦¿ ê´€ë¦¬
    # Settings > Environments > production ì—ì„œ ì„¤ì •
    environment: production

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSHë¡œ ì„œë²„ ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            cd ${{ vars.DEPLOY_PATH || '/opt/uiscloud' }}

            echo "ðŸ“¥ ìµœì‹  ì„¤ì • íŒŒì¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git pull origin main

            echo "ðŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
            bash deployment/scripts/deploy.sh

      - name: ë°°í¬ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "## ë°°í¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ì„œë²„ | \`${{ secrets.SSH_HOST }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ íƒœê·¸ | \`${{ needs.build-web.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°í¬ ì‹œê° | \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
